---
title: "PROJET : PARCOURS DE SOINS POST-GREFFE R√âNALE"
format: html
editor: visual
---

# PRELIMINAIRES

## Chargement des packages

```{r}
# Installer les packages si n√©cessaire (d√©commenter si besoin)
# install.packages("dplyr")
# install.packages("ggplot2")
# install.packages("lubridate")

library(dplyr)
library(ggplot2)
library(lubridate)
```

## Importation des donn√©es

```{r}
list.files()


```

```{r}
data = read.csv("donnees.csv", header = TRUE, sep = ";")
View(data)
```

## V√©rifier l'importation

```{r}
cat("Nombre de lignes :", nrow(data), "\n")
cat("Nombre de colonnes :", ncol(data), "\n")
```

## Structure des donn√©es

```{r}
str(data)
```

```{r}
summary(data)
```

## Variables manquantes

```{r}

est_manquant <- function(x) {
  is.na(x) | (is.character(x) & trimws(x) == "")
}

# Calcul du taux de valeurs manquantes par variable
taux_manquant <- sapply(data, function(col) {
  sum(est_manquant(col)) / length(col) * 100
})

# Dataframe r√©capitulatif
missing_df <- data.frame(
  variable = names(taux_manquant),
  taux_manquant = taux_manquant
)

# Tri d√©croissant par taux de valeurs manquantes
missing_df <- missing_df[order(-missing_df$taux_manquant), ]


```

## Conversion des dates

Vu la structure des dates , nous l'avons ramener au format utilisable par R

```{r}
# Extraire la partie date (avant les ":")
# Exemple : "28JUL2022:00:00:00" devient "28JUL2022"
data$date_greffe_clean <- sub(":.*", "", data$date_greffe)
data$debut_sejour_clean <- sub(":.*", "", data$debut_sejour)
data$fin_sejour_clean <- sub(":.*", "", data$fin_sejour)

# Convertir en format Date
data$date_greffe <- as.Date(data$date_greffe_clean, format="%d%b%Y")
data$debut_sejour <- as.Date(data$debut_sejour_clean, format="%d%b%Y")
data$fin_sejour <- as.Date(data$fin_sejour_clean, format="%d%b%Y")
```

## Idenfication du nombre de patients unique

```{r}
nb_patients <- length(unique(data$study_id))
cat("Nombre de patients uniques :", nb_patients, "\n")
```

2784 patients pour 22132 lignes donc il y a des patients qui ont plusieurs s√©jours

# ANALYSE UNIVARIES

## Structure des donn√©es

La base de donn√©es est de type longitudinale : chaque ligne correspond √† un s√©jour hospitalier, et un m√™me patient (identifi√© par `study_id`) peut appara√Ætre plusieurs fois.

Pour les analyses descriptives, une base agr√©g√©e au niveau patient (une ligne par patient) est construite en conservant la premi√®re greffe observ√©e.

```{r}
data_patients <- data %>%
  group_by(study_id) %>%
  arrange(date_greffe) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(Sexe = factor(COD_SEX, levels = c(1, 2), labels = c("Masculin", "F√©minin")))
```

## Distribution de l'√¢ge des patients

```{r}
summary(data_patients$AGE_ANN)
```

L‚Äô√¢ge des patients greff√©s pr√©sente une m√©diane de 56 ans, proche de la moyenne, indiquant une distribution globalement sym√©trique.\
La moiti√© des patients a un √¢ge compris entre environ 44 et 67 ans, ce qui correspond √† une population d‚Äôadultes d‚Äô√¢ge moyen √† avanc√©.

Ci-joint un histogramme pour une meilleure visualisation :

```{r}
ggplot(data_patients, aes(x = AGE_ANN)) +
geom_histogram(bins = 30, fill = "steelblue", color = "black", alpha = 0.7) +
labs(
title = "Distribution de l'√¢ge des patients √† la greffe",
subtitle = paste("n =", nrow(data_patients), "patients"),
x = "√Çge (ann√©es)",
y = "Nombre de patients"
) +
theme_minimal()
```

Pour la suite de l'√©tude, nous avons opt√© pour une r√©d√©finition des √¢ges en tranches d'√¢ge. Les tranches d‚Äô√¢ge ont √©t√© d√©finies selon des intervalles de 10 ans √† partir de 30 ans, afin de garantir une lecture statistique homog√®ne et de limiter les d√©s√©quilibres d‚Äôeffectifs entre classes. Les seuils retenus (50, 60 et 70 ans) correspondent √† des rep√®res √©pid√©miologiques couramment utilis√©s en transplantation r√©nale, marquant des √©volutions du profil clinique des patients.

Ce choix est √©galement guid√© par l‚Äôexamen de l‚Äôhistogramme de l‚Äô√¢ge, qui met en √©vidence une forte concentration des patients entre 50 et 70 ans. Les classes extr√™mes (\<30 ans et ‚â•80 ans) ont √©t√© regroup√©es afin d‚Äô√©viter des effectifs trop faibles et de garantir une interpr√©tation statistique robuste.

```{r}
data_patients$tranche_age <- cut(
data_patients$AGE_ANN,
breaks = c(0, 30, 40, 50, 60, 70, 80, 120),
labels = c("<30", "30-39", "40-49", "50-59", "60-69", "70-79", "‚â•80")
)

age_summary <- data_patients %>%
group_by(tranche_age) %>%
summarise(n = n()) %>%
mutate(pourcentage = round(n / sum(n) * 100, 1))

age_summary
```

Pour une meilleure visualisation:

```{r}
ggplot(age_summary, aes(x = tranche_age, y = n)) +
geom_col(fill = "steelblue", color = "black", alpha = 0.8) +
geom_text(
aes(label = paste0(n, " (", pourcentage, "%)")),
vjust = -0.3,
size = 3
) +
labs(
title = "R√©partition des patients par tranche d‚Äô√¢ge",
x = "Tranche d‚Äô√¢ge (ann√©es)",
y = "Nombre de patients"
) +
theme_minimal()

```

## Distribution par sexe des patients

```{r}
# Tableau de distribution par sexe
sexe_summary <- data_patients %>%
  group_by(Sexe) %>%
  summarise(
    effectif = n(),
    .groups = "drop"
  ) %>%
  mutate(
    pourcentage = round(effectif / sum(effectif) * 100, 1)
  )

print(sexe_summary)

ggplot(sexe_summary, aes(x = Sexe, y = effectif, fill = Sexe)) +
  geom_col(alpha = 0.8, color = "black") +
  geom_text(
    aes(label = paste0(effectif, " (", pourcentage, "%)")),
    vjust = -0.3,
    size = 4
  ) +
  coord_cartesian(ylim = c(0, 2000)) +   # üëà MODIFIE ICI selon ton besoin
  labs(
    title = "R√©partition des patients greff√©s par sexe",
    subtitle = paste("n =", nrow(data_patients), "patients"),
    x = "Sexe",
    y = "Nombre de patients"
  ) +
  theme_minimal() +
  theme(legend.position = "none")



```

commentaires.....

## Analyse des s√©jour post-greffe

### Dur√©e de s√©jour par patients

Dans les pr√©liminaires , nous avons constater que les patients peuvent avoir plusieurs s√©jours , nous avons d√©cid√© de v√©rifier le nombre exacte de s√©jour par patients

D'abord nous regardons la dur√©e de s√©jour par ligne dans la base de donn√©es avant de faire le regroupement par patient

```{r}
data$duree_sejour <- as.numeric(data$fin_sejour - data$debut_sejour)
data$duree_sejour[data$duree_sejour == 0] <- 1
```

Remarquons que lorsque la dur√©e du s√©jour fait 0, nous l'initialisons √† 1 afin d'avoir une bonne repr√©sentativit√© vu l'op√©ration math√©matique qui est r√©alis√©e.

Nous groupons maintenant par patient:

```{r}
sejours_par_patient) <- data %>%
  group_by(study_id) %>%
  summarise(nb_sejours = n()) %>%
  ungroup()

cat("\nNombre de s√©jours par patient :\n")
print(summary(sejours_par_patient$nb_sejours))
```

H√©t√©rog√©n√©it√© majeure : De 1 √† 3 101 s√©jours !

25% avec peu de suivi (1-2 s√©jours)

50% avec suivi standard (2-7 s√©jours)

25% avec suivi intensif (\>7 s√©jours)

La m√©diane (4) est plus repr√©sentative que la moyenne (7.95)

### Graphiquement

```{r}
dist_sejours <- table(table(data$study_id))

barplot(
  dist_sejours,
  xlab = "Nombre de s√©jours par patient",
  ylab = "Nombre de patients",
  main = "Distribution du nombre de s√©jours par patient",
  col = "steelblue"
)
```

401 patients ont 1 seul s√©jour (probablement juste la greffe, sans r√©hospitalisation) ligne de code 102

436 patients ont 2 s√©jours \# La majorit√© des patients ont entre 1 et 10 s√©jours

Quelques patients ont un suivi tr√®s intensif : jusqu'√† 3101 s√©jours pour un patient !

### Densit√© des s√©jours

```{r}
# # D√©lai entre greffe et d√©but du s√©jour de suivi (en jours)
data$delai_greffe_suivi <- as.numeric(data$debut_sejour - data$date_greffe)

# Dur√©e du s√©jour de suivi (en jours)
data$duree_sejour <- as.numeric(data$fin_sejour - data$debut_sejour)

# Distribution temporelle des s√©jours de suivi
delais_tranches <- table(cut(data$delai_greffe_suivi, 
                             breaks = c( 0, 7, 30, 90, 180, 365, Inf),
                             labels = c("0-7j", "8-30j", "1-3mois", 
                                        "3-6mois", "6-12mois", ">12mois")))
cat("\nDistribution temporelle des s√©jours de suivi :\n")
print(delais_tranches)
cat("\nPourcentages :\n")
print(round(prop.table(delais_tranches) * 100, 1))


# Graphiquement :

df_plot <- as.data.frame(delais_tranches)
colnames(df_plot) <- c("classe_delai", "nb_sejours")

# Forcer l‚Äôordre logique des classes
df_plot$classe_delai <- factor(
  df_plot$classe_delai,
  levels = c("N√©gatif", "0-7j", "8-30j", "1-3mois",
             "3-6mois", "6-12mois", ">12mois")
)

ggplot(df_plot, aes(x = classe_delai, y = nb_sejours)) +
  geom_col(fill = "steelblue") +
  labs(
    title = "Distribution temporelle des s√©jours de suivi",
    x = "s√©jour de suivi",
    y = "Nombre de s√©jours"
  ) +
  theme_minimal()
```

Concentration majeure entre 1 et 6 mois

Le pic principal se situe dans la classe 1‚Äì3 mois, qui regroupe le plus grand nombre de s√©jours.

Les classes 3‚Äì6 mois et 8‚Äì30 jours pr√©sentent √©galement des effectifs √©lev√©s.

Cela traduit une intensit√© du suivi dans les premiers mois post-greffe, p√©riode critique sur le plan m√©dical.

Suivi pr√©coce mais non imm√©diat

Les s√©jours dans les 0‚Äì7 jours sont relativement peu nombreux compar√©s aux classes suivantes.

Le suivi imm√©diat post-greffe semble moins fr√©quent dans cette base, ou bien g√©r√© dans un autre cadre (hospitalisation initiale).

Diminution progressive √† long terme

Les s√©jours entre 6‚Äì12 mois sont encore pr√©sents mais en baisse. \# Les s√©jours √† plus de 12 mois sont tr√®s rares. \# Le suivi devient plus espac√© √† mesure que le temps depuis la greffe augmente. \# conclusion chat \# La distribution temporelle des s√©jours de suivi met en √©vidence une forte concentration \# des consultations dans les premiers mois suivant la greffe, avec un pic marqu√© entre 1 et 3 mois. \# Cette dynamique est coh√©rente avec les protocoles de suivi intensif post-greffe. \# Les s√©jours √† plus long terme deviennent progressivement moins fr√©quents, \# traduisant un espacement du suivi pour les patients stabilis√©s.

## Nombre de greffe par patients

```{r}
greffes_par_patient <- data %>%
  distinct(study_id, date_greffe, RSA_NUM) %>%
  group_by(study_id) %>%
  summarise(nb_greffes = n()) %>%
  ungroup()

cat("\nNombre de greffes par patient :\n")
print(table(greffes_par_patient$nb_greffes))
```

## Distribution du nombre de greffe par mois

```{r}
# Distribution temporelle des greffes
data_patients$mois_greffe <- format(data_patients$date_greffe, "%Y-%m")

# Cr√©er variables mois et ann√©e
data_patients$annee <- format(data_patients$date_greffe, "%Y")
data_patients$mois_num <- format(data_patients$date_greffe, "%m")

# Calculer le nombre par mois et ann√©e
greffes_heatmap <- data_patients %>%
  mutate(mois = as.Date(format(date_greffe, "%Y-%m-01"))) %>%
  group_by(mois) %>%
  summarise(nb_greffes = n(), .groups = "drop")


# Graphiquement
ggplot(greffes_heatmap, aes(x = mois, y = nb_greffes)) +
  geom_col(fill = "lightblue", color = "black", alpha = 0.7) +
  labs(
    title = "√âvolution mensuelle du nombre de greffes r√©nales",
    x = "Date",
    y = "Nombre de greffes"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))


```

-   Apr√®s un **niveau tr√®s faible en d√©but de p√©riode**, le nombre mensuel de greffes augmente rapidement.

    L‚Äôactivit√© se stabilise ensuite autour d‚Äôun **plateau compris approximativement entre 200 et 300 greffes par mois**.

    Une **baisse en fin de p√©riode** est visible.(li√©e √† une p√©riode incompl√®te de collecte des donn√©e? ou vrai dimunition)

## Top 10 des diagnostics principaux chez les patients

```{r}
# Pr√©paration des donn√©es
top_dgn_pal <- sort(table(data_patients$DGN_PAL), decreasing = TRUE)[1:10]
df_dgn <- data.frame(
  diagnostic = names(top_dgn_pal),
  nombre = as.numeric(top_dgn_pal)
)

# Calculer les pourcentages
df_dgn$pourcentage <- round(df_dgn$nombre / nrow(data_patients) * 100, 1)

# R√©ordonner pour le graphique (du plus fr√©quent au moins fr√©quent)
df_dgn$diagnostic <- factor(df_dgn$diagnostic, 
                            levels = df_dgn$diagnostic)


# Graphiquement 
ggplot(df_dgn, aes(x = reorder(diagnostic, nombre), y = nombre)) +
  geom_bar(stat = "identity", fill = "steelblue", color = "black") +
  geom_text(aes(label = paste0(nombre, " (", pourcentage, "%)")), 
            hjust = -0.1, size = 3.5) +
  coord_flip() +
  labs(title = "Top 10 des diagnostics principaux √† la greffe",
       subtitle = "Nombre de patients et pourcentage",
       x = "Code diagnostic (CIM-10)",
       y = "Nombre de patients") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14)) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
```

On a besoin de connaitre la signification des codes pour savoir quelle interpr√©tation donn√©e

## Top 10 des dignostics reli√© √† la greffe

```{r}
top_dgn_rel <- sort(table(data_patients$DGN_REL), decreasing = TRUE)[1:10]
df_dgn_rel <- data.frame(
  diagnostic = names(top_dgn_rel),
  nombre = as.numeric(top_dgn_rel)
)

# Calculer les pourcentages
df_dgn_rel$pourcentage <- round(df_dgn_rel$nombre / nrow(data_patients) * 100, 1)

# Graphquement
ggplot(df_dgn_rel, aes(x = reorder(diagnostic, nombre), y = nombre)) +
  geom_bar(stat = "identity", fill = "coral", color = "black") +
  geom_text(aes(label = paste0(nombre, " (", pourcentage, "%)")), 
            hjust = -0.1, size = 3.5, fontface = "bold") +
  coord_flip() +
  labs(title = "Top 10 des diagnostics reli√©s √† la greffe",
       subtitle = paste("n =", nrow(data_patients), "patients"),
       x = "Code diagnostic reli√© (CIM-10)",
       y = "Nombre de patients") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
```

Idem , on ne peut pas dire grand chose( code vide==XXXX ? )

## Top 10 des √©tablissement qui font plus de greffe

```{r}
# Pr√©parer les donn√©es
top_eta <- sort(table(data_patients$ETA_NUM), decreasing = TRUE)[1:10]
df_eta <- data.frame(
  etablissement = names(top_eta),
  nombre = as.numeric(top_eta)
)

# Calculer les pourcentages
df_eta$pourcentage <- round(df_eta$nombre / nrow(data_patients) * 100, 1)

# Calculer le nombre total d'√©tablissements
nb_etablissements <- length(unique(data_patients$ETA_NUM))

# Calculer la part des "autres" √©tablissements
nb_top10 <- sum(df_eta$nombre)
nb_autres <- nrow(data_patients) - nb_top10


# GRAPHIQUE : Barplot horizontal avec pourcentages

ggplot(df_eta, aes(x = reorder(etablissement, nombre), y = nombre)) +
  geom_bar(stat = "identity", fill = "darkgreen", color = "black", alpha = 0.8) +
  geom_text(aes(label = paste0(nombre, " (", pourcentage, "%)")), 
            hjust = -0.1, size = 3.5, fontface = "bold") +
  coord_flip() +
  labs(title = "Top 10 des √©tablissements r√©alisant des greffes r√©nales",
       subtitle = paste("Sur", nb_etablissements, "√©tablissements au total |",
                        nrow(data_patients), "patients greff√©s"),
       x = "Code √©tablissement",
       y = "Nombre de greffes r√©alis√©es") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 13),
        plot.subtitle = element_text(size = 10),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
```

Concentration extr√™me sur UN √©tablissement :

750712184 : 528 greffes (19% du total) ‚Üí Centre ultra-dominant

Presque 3x plus que le 2√®me √©tablissement \#

√Ä lui seul = autant que les 7 suivants r√©unis

Distribution des autres centres :

2√®me rang (330781196) : 188 greffes (6.8%) ‚Üí √âcart √©norme avec le 1er

3√®me au 10√®me rang : entre 102 et 180 greffes (3.7% √† 6.5%)

Distribution relativement homog√®ne entre eux (pas de 2√®me "super-centre")

Activit√© des 10 premiers :

Total Top 10 : ‚âà 1753 greffes

\% du total : 1753/2784 = 63% des greffes r√©alis√©es par 10 centres sur 30

20 autres centres se partagent seulement 37% de l'activit√©

# ANALYSE BIVARIEES

## Dur√©e de s√©jour par sexe

Nous allons joindre l'information du sexe (pr√©sente dans `data_patients`) √† notre d√©compte de s√©jours.

```{r}
sejours_sexe <- sejours_par_patient %>%
  left_join(data_patients %>% select(study_id, Sexe), by = "study_id")

head(sejours_sexe)
```

```{r}
summary_sejours_sexe <- sejours_sexe %>%
  group_by(Sexe) %>%
  summarise(
    n_patients = n(),
    moyenne = round(mean(nb_sejours), 2),
    mediane = median(nb_sejours),
    ecart_type = round(sd(nb_sejours), 2),
    max = max(nb_sejours)
  )

print(summary_sejours_sexe)
```

Visualisation :

```{r}
ggplot(sejours_sexe, aes(x = Sexe, y = nb_sejours, fill = Sexe)) +
  geom_boxplot(alpha = 0.7) +
  # On limite l'affichage √† 50 s√©jours pour que le graphique soit lisible
  coord_cartesian(ylim = c(0, 50)) + 
  labs(
    title = "Nombre de s√©jours post-greffe par sexe",
    subtitle = "Zoom sur les patients (0 √† 50 s√©jours)",
    x = "Sexe",
    y = "Nombre total de s√©jours"
  ) +
  theme_minimal()
```

Test Statistique (Mann-Whitney / Wilcoxon) Vu que les donn√©es sont tr√®s √©tal√©es

```{r}
wilcox.test(nb_sejours ~ Sexe, data = sejours_sexe)
```

Le test de Wilcoxon cherche √† d√©terminer si la distribution du nombre de s√©jours est significativement diff√©rente entre les hommes et les femmes. Comme vous avez des valeurs tr√®s extr√™mes (le patient √† 3101 s√©jours), ce test est id√©al car il ne se laisse pas influencer par ces "outliers" (valeurs aberrantes), contrairement √† un test de moyenne classique.

Interpr√©tation du test :

Le test de Wilcoxon compare la distribution du nombre de s√©jours entre les hommes et les femmes. Avec une p value de 0,24, le test n'est pas significatif au seuil de 5 %. Cela signifie qu'il n'existe pas de preuve statistique d'une diff√©rence de comportement de suivi entre les deux sexes.

Le sexe du patient ne semble pas √™tre un facteur influen√ßant l'intensit√© du parcours de soins post-greffe (nombre de r√©hospitalisations ou de consultations). Les hommes et les femmes re√ßoivent, en moyenne, un nombre de soins √©quivalent dans cette cohorte.

## Distribution de l‚Äô√¢ge √† la greffe par sexe

```{r}
summary_age_sexe <- data_patients %>%
  group_by(Sexe) %>%
  summarise(
    n = n(),
    age_moyen = mean(AGE_ANN, na.rm = TRUE),
    age_mediane = median(AGE_ANN, na.rm = TRUE),
    ecart_type = sd(AGE_ANN, na.rm = TRUE)
  )
print(summary_age_sexe)
```

Visualisation :

```{r}
ggplot(data_patients, aes(x = Sexe, y = AGE_ANN, fill = Sexe)) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "Comparaison de l'√¢ge des patients par sexe",
    subtitle = "Base agr√©g√©e (1 ligne par patient)",
    x = "Sexe",
    y = "√Çge (ann√©es)"
  ) +
  theme_minimal()
```

Proposition de test statistique: t_test

```{r}
t.test(AGE_ANN ~ Sexe, data = data_patients)
```

Observation : Les hommes de l'√©chantillon sont en moyenne l√©g√®rement plus √¢g√©s que les femmes (environ 1,7 an de diff√©rence). Les m√©dianes confirment cette tendance (57 ans pour les hommes contre 55 ans pour les femmes).

R√©sultat du test t :

-   **Interpr√©tation :** La p-value est largement inf√©rieure au seuil de **0,05**. Cela signifie que la diff√©rence d'√¢ge entre les hommes et les femmes est **statistiquement significative**.

    Bien que la diff√©rence soit statistiquement r√©elle, elle reste de faible ampleur (moins de 2 ans). Cela peut sugg√©rer que les hommes ont tendance √† √™tre greff√©s √† un √¢ge l√©g√®rement plus avanc√© que les femmes.

Voyons cela avec le calcul de l'√©tat carr√© pour la puissance du test :

```{r}
library(effectsize)
t_to_eta2(t = 2.9093, df_error = 2137.2)
```

On voit bien la valeur de l'√©tat carr√© tr√®s faible. D'o√π la confirmation de ce qu'on disait.

## Dur√©e de suivi par √¢ge

.forte dispersion des parcours de soins, quel que soit l'√¢ge du patient

Pour l‚Äôensemble des √¢ges, la majorit√© des patients pr√©sente une dur√©e cumul√©e de s√©jour relativement faible (souvent inf√©rieure √† 100 jours), tandis qu‚Äôun nombre restreint de patients conna√Æt des dur√©es nettement plus √©lev√©es, traduisant des parcours de soins complexes ou des complications post-greffe. Cette h√©t√©rog√©n√©it√© est observable √† tous les √¢ges, y compris chez les patients jeunes.

tendance l√©g√®rement croissante de la dur√©e totale de s√©jour avec l‚Äô√¢ge : Toutefois, cette augmentation reste mod√©r√©e et largement masqu√©e par la variabilit√© interindividuelle tr√®s importante.

Biais √©ventuels :

**Censure temporelle des donn√©es :** BDD limit√©e √† 2022. Les patients greff√©s en fin de p√©riode disposent m√©caniquement d‚Äôun temps de suivi plus court =\> censure √† droite de la dur√©e.

**Dur√©e de suivi variable selon les patients** Les patients plus anciens dans la base ont m√©caniquement davantage d‚Äôopportunit√©s d‚Äôaccumuler des s√©jours, ce qui peut confondre l‚Äôeffet de l‚Äô√¢ge avec celui du temps d‚Äôobservation.

```{r}

# Dur√©e totale de s√©jour par patient (en jours)
duree_par_patient <- data %>%
  mutate(
    duree_sejour = as.numeric(fin_sejour - debut_sejour),
    duree_sejour = ifelse(duree_sejour <= 0, 1, duree_sejour)
  ) %>%
  group_by(study_id) %>%
  summarise(
    duree_totale = sum(duree_sejour, na.rm = TRUE),
    .groups = "drop"
  )

# Jointure avec l'√¢ge √† la greffe
duree_age <- duree_par_patient %>%
  left_join(
    data_patients %>% select(study_id, AGE_ANN),
    by = "study_id"
  )

summary(duree_age)


ggplot(duree_age, aes(x = AGE_ANN, y = duree_totale)) +
  geom_point(alpha = 0.3, color = "steelblue") +
  geom_smooth(
    method = "loess",
    se = FALSE,
    color = "red",
    linewidth = 1.2
  ) +
  coord_cartesian(ylim = c(0, 400)) +
  labs(
    title = "Dur√©e totale de s√©jour post-greffe selon l‚Äô√¢ge √† la greffe",
    subtitle = "Axe des ordonn√©es limit√© √† 1000 jours (meilleure lisibilit√©)",
    x = "√Çge √† la greffe (ann√©es)",
    y = "Dur√©e totale de s√©jour (jours)"
  ) +
  theme_minimal()
```

test de spearman : suppose pas de relation lin√©aire ni de normalit√© (avec des valeurs extr√™mes, censur√©e ou tronqu√©e ? pas forc√©ment normal)

```{r}
cor_spearman <- cor.test(
  duree_age$AGE_ANN,
  duree_age$duree_totale,
  method = "spearman",
  exact = FALSE
)

print(cor_spearman)

```

Afin de limiter ces biais, une **analyse compl√©mentaire restreinte √† une dur√©e de suivi maximale de 100j post-greffe** sera r√©alis√©e. Cette approche permettra :

d‚Äôhomog√©n√©iser la fen√™tre d‚Äôobservation entre les patients,de r√©duire l‚Äôeffet de la censure temporelle, et d‚Äô√©valuer plus finement l‚Äôimpact de l‚Äô√¢ge sur l‚Äôintensit√© du suivi √† court

```{r}
# Un s√©jour qui d√©passe 100 jours est tronqu√© mais pas supprim√© 
# D√©finition de la fen√™tre de suivi (100 jours)
fenetre_100j <- 100

data_100j <- data %>%
  mutate(
    # D√©lai entre greffe et d√©but du s√©jour
    delai_greffe_sejour = as.numeric(debut_sejour - date_greffe),

    # Fin th√©orique du suivi √† 12 mois
    fin_suivi_100j = date_greffe + fenetre_100j,

    # Fin r√©elle du s√©jour tronqu√©e √† 100j
    fin_sejour_tronquee = pmin(fin_sejour, fin_suivi_100j),

    # Dur√©e de s√©jour dans la fen√™tre des 12 mois
    duree_sejour_100j = as.numeric(fin_sejour_tronquee - debut_sejour)
  ) %>%
  # Conserver uniquement les s√©jours qui commencent dans les 12 mois
  filter(delai_greffe_sejour >= 0 & delai_greffe_sejour <= fenetre_100j) %>%
  mutate(
    duree_sejour_100j = ifelse(duree_sejour_100j <= 0, 1, duree_sejour_100j)
  )

```

```{r}
duree_100j_par_patient <- data_100j %>%
  group_by(study_id) %>%
  summarise(
    duree_totale_100j = sum(duree_sejour_100j, na.rm = TRUE),
    .groups = "drop"
  )

# Jointure avec l'√¢ge √† la greffe
duree_age_100j <- duree_100j_par_patient %>%
  left_join(
    data_patients %>% select(study_id, AGE_ANN),
    by = "study_id"
  )

summary(duree_age_100j)

```

```{r}
duree_100j_par_patient <- data_100j %>%
  group_by(study_id) %>%
  summarise(
    duree_totale_100j = sum(duree_sejour_100j, na.rm = TRUE),
    .groups = "drop"
  )

# Jointure avec l'√¢ge √† la greffe
duree_age_100j <- duree_100j_par_patient %>%
  left_join(
    data_patients %>% select(study_id, AGE_ANN),
    by = "study_id"
  )

summary(duree_age_100j)

duree_100j_par_patient <- data_100j %>%
  group_by(study_id) %>%
  summarise(
    duree_totale_100j = sum(duree_sejour_100j, na.rm = TRUE),
    .groups = "drop"
  )

# Jointure avec l'√¢ge √† la greffe
duree_age_100j<- duree_100j_par_patient %>%
  left_join(
    data_patients %>% select(study_id, AGE_ANN),
    by = "study_id"
  )

summary(duree_age_100j)

```

```{r}
ggplot(duree_age_100j, aes(x = AGE_ANN, y = duree_totale_100j)) +
  geom_point(alpha = 0.3, color = "steelblue") +
  geom_smooth(
    method = "loess",
    se = FALSE,
    color = "red",
    linewidth = 1.2
  ) +
  coord_cartesian(ylim = c(0, 100)) +
  labs(
    title = "Dur√©e totale de s√©jour post-greffe (‚â§ 100j) selon l‚Äô√¢ge",
    subtitle = "Fen√™tre de suivi homog√®ne ‚Äì lissage LOESS",
    x = "√Çge √† la greffe (ann√©es)",
    y = "Dur√©e totale de s√©jour sur 100j"
  ) +
  theme_minimal()

```

```{r}
cor_spearman_100j <- cor.test(
  duree_age_100j$AGE_ANN,
  duree_age_100j$duree_totale_100j,
  method = "spearman",
  exact = FALSE
)

print(cor_spearman_100j)

```

```{r}

# Cr√©ation des classes d'√¢ge
duree_age_100j <- duree_100j_par_patient %>%
  left_join(
    data_patients %>% select(study_id, AGE_ANN),
    by = "study_id"
  ) %>%
  mutate(
    classe_age = cut(
      AGE_ANN,
      breaks = c(-Inf, 29, 39, 49, 59, 69, 79, Inf),
      labels = c("<30", "30-39", "40-49", "50-59", "60-69", "70-79", "‚â•80"),
      right = TRUE
    )
  )

# V√©rifions un r√©sum√©
table(duree_age_100j$classe_age)

# Graphique : boxplot par classe d'√¢ge
ggplot(duree_age_100j, aes(x = classe_age, y = duree_totale_100j)) +
  geom_boxplot(fill = "steelblue", alpha = 0.5, outlier.shape = NA) +
  #geom_jitter(width = 0.2, alpha = 0.3, color = "darkblue") +
  labs(
    title = "Dur√©e totale de s√©jour post-greffe (‚â§ 12 mois) selon les classes d‚Äô√¢ge",
    x = "Classe d‚Äô√¢ge (ann√©es)",
    y = "Dur√©e totale de s√©jour sur 12 mois (jours)"
  ) +
  theme_minimal()

```

Test de Kruskal‚ÄìWallis : distributions asym√©triques, variances diff√©rentes, comparaison de \>2 groupes epsilon_carr√© = l‚Äô√©quivalent non param√©trique du R¬≤. `kruskal.test()` effectue le test de comparaison des distributions entre les classes d‚Äô√¢ge. La statistique de Kruskal‚ÄìWallis (`H`) est transform√©e en **eta¬≤** pour avoir un **indicateur de force d‚Äôassociation** entre la classe d‚Äô√¢ge et la dur√©e totale `eta2` varie entre 0 et 1 : plus elle est proche de 1, plus l‚Äôassociation est forte. `k` = nombre de classes d‚Äô√¢ge, `n` = nombre total de patients.

```{r}
# Test de Kruskal-Wallis
kruskal_test <- kruskal.test(duree_totale_100j ~ classe_age, data = duree_age_100j)
kruskal_test

# Calcul de l'eta carr√© pour Kruskal-Wallis (taille d'effet)
# formule : eta2 = (H - k + 1) / (n - k), H = statistique du test, k = nb de groupes, n = taille totale
H <- kruskal_test$statistic
k <- length(unique(duree_age_100j$classe_age))
n <- nrow(duree_age_100j)
eta2 <- (H - k + 1) / (n - k)

eta2

```

## Diagnostic principal √ó √¢ge

Dans la base de donn√©es, nous avons beaucoup de modalit√©s par les diagnostics principaux. Dans l'optique d'avoir des r√©sultats visibles, nous choisissons de prendre le top 5 juste pour l'analyse bivari√©e car en consid√©rant toutes les modalit√©s, nous obtenons pas de r√©sultats interpr√©tables.

Ajoutons d'abord les tranches d'√¢ge dans data_patients

```{r}
data_patients <- data %>%
  group_by(study_id) %>%
  arrange(date_greffe) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    # Votre code existant
    Sexe = factor(COD_SEX, levels = c(1, 2), labels = c("Masculin", "F√©minin")),
    
    # L'ajout de la tranche d'√¢ge
    tranche_age = cut(
      AGE_ANN,
      breaks = c(0, 30, 40, 50, 60, 70, 80, 120),
      labels = c("<30", "30-39", "40-49", "50-59", "60-69", "70-79", "‚â•80"),
      right = FALSE
    )
  )
```

Extraction du Top 5 des codes diagnostics par tranche d'√¢ge

```{r}
top5_dgn_age <- data_patients %>%
  group_by(tranche_age, DGN_PAL) %>%
  summarise(effectif = n(), .groups = "drop") %>%
  group_by(tranche_age) %>%
  slice_max(order_by = effectif, n = 5) %>%
  ungroup()

print(top5_dgn_age)
```

Visualisation : graphique par facettes

```{r}
ggplot(top5_dgn_age, aes(x = reorder(DGN_PAL, effectif), y = effectif, fill = tranche_age)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~tranche_age, scales = "free_y") +
  labs(
    title = "Top 5 des codes diagnostics principaux par tranche d'√¢ge",
    x = "Code Diagnostic",
    y = "Nombre de patients"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

Interpr√©tations : Le code **Z940** est l'√©tiquette dominante pour toutes les tranches d'√¢ge. Les codes **Z512** et **RSSABS** compl√®tent r√©guli√®rement le podium, montrant une certaine uniformit√© dans le codage des dossiers, peu importe l'√¢ge.

On remarque aussi que pour les tranches d'√¢ges √©lev√©es( plus de 70 ans), de nouveaux codes apparaissent dans le Top 5 (comme Z491 ou T861), ce qui n'est pas le cas chez les plus jeunes.

Proc√©dons maintenant √† un test de chi-deux.

R√©alisation du test du Chi-deux:

```{r}
# 1. Cr√©ation de la table de contingence
table_dgn_age <- table(data_patients$tranche_age, data_patients$DGN_PAL)

# 2. R√©alisation du test du Chi-deux
test_chi2 <- chisq.test(table_dgn_age)

# 3. Affichage du r√©sultat
print(test_chi2)
```

Il n'y a pas de lien statistiquement significatif entre l'√¢ge du patient et son diagnostic principal vu que le test n'est pas significatif (La valeur de la p-value). Les motifs de prise en charge sont distribu√©s de mani√®re similaire √† travers toutes les tranches d'√¢ge.

## Diagnostic principal √ó dur√©e moyenne de s√©jour

```{r}
# Dur√©e totale de s√©jour par patient (d√©j√† coh√©rent avec ce que vous avez fait)
duree_par_patient <- data %>%
  mutate(
    duree_sejour = as.numeric(fin_sejour - debut_sejour),
    duree_sejour = ifelse(duree_sejour <= 0, 1, duree_sejour)
  ) %>%
  group_by(study_id) %>%
  summarise(
    duree_totale = sum(duree_sejour, na.rm = TRUE),
    .groups = "drop"
  )

# Jointure avec le diagnostic principal √† la greffe
duree_diagnostic <- duree_par_patient %>%
  left_join(
    data_patients %>% select(study_id, DGN_PAL),
    by = "study_id"
  )

```

√©vite l'effet bruit et rend les r√©sultats lisibles

```{r}
# Top 5 diagnostics principaux
top5_dgn <- data_patients %>%
  count(DGN_PAL, sort = TRUE) %>%
  slice_head(n = 5) %>%
  pull(DGN_PAL)

duree_diagnostic_top5 <- duree_diagnostic %>%
  filter(DGN_PAL %in% top5_dgn)

```

-   Moyenne \> m√©diane ‚Üí asym√©trie √† droite

    Variabilit√© importante selon le diagnostic

    Justifie l‚Äôusage de tests non param√©triques

```{r}
table_duree_dgn <- duree_diagnostic_top5 %>%
  group_by(DGN_PAL) %>%
  summarise(
    n_patients = n(),
    duree_moyenne = round(mean(duree_totale), 1),
    duree_mediane = median(duree_totale),
    ecart_type = round(sd(duree_totale), 1),
    .groups = "drop"
  ) %>%
  arrange(desc(duree_moyenne))

print(table_duree_dgn)

```

```{r}
ggplot(duree_diagnostic_top5,
       aes(x = reorder(DGN_PAL, duree_totale, FUN = median),
           y = duree_totale)) +
  geom_boxplot(fill = "steelblue", alpha = 0.6, outlier.shape = NA) +
  coord_cartesian(ylim = c(0, 150)) +
  labs(
    title = "Dur√©e totale de s√©jour post-greffe selon le diagnostic principal",
    subtitle = "Top 5 des diagnostics ‚Äì niveau patient",
    x = "Diagnostic principal (CIM-10)",
    y = "Dur√©e totale de s√©jour (jours)"
  ) +
  theme_minimal()

```

```{r}
kruskal_dgn <- kruskal.test(
  duree_totale ~ DGN_PAL,
  data = duree_diagnostic_top5
)

kruskal_dgn

```

```{r}
# Calcul de l'eta carr√©
H <- kruskal_dgn$statistic
k <- length(unique(duree_diagnostic_top5$DGN_PAL))
n <- nrow(duree_diagnostic_top5)

eta2_dgn <- (H - k + 1) / (n - k)
eta2_dgn

```

La dur√©e totale de s√©jour post-greffe varie fortement selon le diagnostic principal √† la greffe. Le graphique met en √©vidence une **augmentation progressive de la dur√©e de s√©jour m√©diane et de la dispersion** en fonction des diagnostics, avec des profils de parcours tr√®s contrast√©s.

Les patients cod√©s **Z940** et **Z512** pr√©sentent des dur√©es de s√©jour globalement courtes et peu dispers√©es, traduisant des parcours de soins relativement simples et standardis√©s.\
√Ä l‚Äôinverse, les diagnostics **RSSABS** et surtout **Z491** sont associ√©s √† des dur√©es de s√©jour nettement plus longues, avec une variabilit√© tr√®s importante, sugg√©rant des parcours plus complexes, probablement li√©s √† des complications, des reprises chirurgicales ou un suivi m√©dical intensif.

Le test de **Kruskal‚ÄìWallis** met en √©vidence une diff√©rence statistiquement significative entre les diagnostics principaux (p-value \< 0,05). La taille d‚Äôeffet mesur√©e par l‚Äôeta carr√© (Œ∑¬≤ = 0,186) indique une **association forte** entre le diagnostic principal √† la greffe et l‚Äôintensit√© du parcours de soins post-greffe. Autrement dit, pr√®s de **19 % de la variabilit√© de la dur√©e totale de s√©jour** est expliqu√©e par le diagnostic principal.

## Diagnostic √ó nombre de r√©hospitalisations

```{r}
data <- data %>%
  mutate(
    duree_sejour = as.numeric(fin_sejour - debut_sejour),
    duree_sejour = ifelse(duree_sejour <= 0, 1, duree_sejour)
  )

```

```{r}
# comptage des r√©hospitalisations 
rehosp_par_patient <- data %>%
  filter(duree_sejour > 1) %>%      
  group_by(study_id) %>%
  summarise(
    nb_rehospitalisations = n(),
    .groups = "drop"
  )

```

```{r}
# r√©int√©gration des patients sans r√©hospitalisation
rehosp_par_patient <- data_patients %>%
  select(study_id) %>%
  left_join(rehosp_par_patient, by = "study_id") %>%
  mutate(
    nb_rehospitalisations = ifelse(
      is.na(nb_rehospitalisations), 0, nb_rehospitalisations
    )
  )

# jointure avec le diagnoqtique principal 
rehosp_diagnostic <- rehosp_par_patient %>%
  left_join(
    data_patients %>% select(study_id, DGN_PAL),
    by = "study_id"
  )

# restrictions auw diagnistiques principaux les plus fr√©quents
top5_dgn <- data_patients %>%
  count(DGN_PAL, sort = TRUE) %>%
  slice_head(n = 5) %>%
  pull(DGN_PAL)

rehosp_diagnostic_top5 <- rehosp_diagnostic %>%
  filter(DGN_PAL %in% top5_dgn)

```

```{r}
# tableau descriptif
table_rehosp_dgn <- rehosp_diagnostic_top5 %>%
  group_by(DGN_PAL) %>%
  summarise(
    n_patients = n(),
    moyenne = round(mean(nb_rehospitalisations), 2),
    mediane = median(nb_rehospitalisations),
    ecart_type = round(sd(nb_rehospitalisations), 2),
    max = max(nb_rehospitalisations),
    .groups = "drop"
  ) %>%
  arrange(desc(moyenne))

print(table_rehosp_dgn)

```

```{r}
# graphique 
ggplot(rehosp_diagnostic_top5,
       aes(x = reorder(DGN_PAL, nb_rehospitalisations, FUN = median),
           y = nb_rehospitalisations)) +
  geom_boxplot(fill = "steelblue", alpha = 0.6, outlier.shape = NA) +
  coord_cartesian(ylim = c(0, 30)) +
  labs(
    title = "Nombre de r√©hospitalisations post-greffe (> 1 jour)",
    subtitle = "Dur√©e calcul√©e selon la d√©finition du projet",
    x = "Diagnostic principal (CIM-10)",
    y = "Nombre de r√©hospitalisations"
  ) +
  theme_minimal()

```

```{r}
# test de kruskal wallis
kruskal_rehosp <- kruskal.test(
  nb_rehospitalisations ~ DGN_PAL,
  data = rehosp_diagnostic_top5
)

kruskal_rehosp

```

```{r}
# effet 
H <- kruskal_rehosp$statistic
k <- length(unique(rehosp_diagnostic_top5$DGN_PAL))
n <- nrow(rehosp_diagnostic_top5)

eta2_rehosp <- (H - k + 1) / (n - k)
eta2_rehosp

```
