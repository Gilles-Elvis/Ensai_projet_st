---
title: "preparation_donnees"
format: html
editor: visual
---

# PRELIMINAIRES

## Chargement des packages

```{r}
# Installer les packages si nécessaire (décommenter si besoin)
# install.packages("dplyr")
# install.packages("ggplot2")
# install.packages("lubridate")

library(dplyr)
library(ggplot2)
library(lubridate)
```

## Importation des données

```{r}
data = read.csv("donnees.csv", header = TRUE, sep = ";")
View(data)
```

## Vérifier l'importation

```{r}
cat("Nombre de lignes :", nrow(data), "\n")
cat("Nombre de colonnes :", ncol(data), "\n")
```

## Structure des données

```{r}
str(data)
```

```{r}
summary(data)
```

## Variables manquantes

```{r}
est_manquant <- function(x) {
  is.na(x) | (is.character(x) & trimws(x) == "")
}

# Calcul du taux de valeurs manquantes par variable
taux_manquant <- sapply(data, function(col) {
  sum(est_manquant(col)) / length(col) * 100
})

# Dataframe récapitulatif
missing_df <- data.frame(
  variable = names(taux_manquant),
  taux_manquant = taux_manquant
)

# Tri décroissant par taux de valeurs manquantes
missing_df <- missing_df[order(-missing_df$taux_manquant), ]

```

## Conversion des dates

Vu la structure des dates , nous l'avons ramener au format utilisable par Rw

```{r}
# Extraire la partie date (avant les ":")
# Exemple : "28JUL2022:00:00:00" devient "28JUL2022"
data$date_greffe_clean <- sub(":.*", "", data$date_greffe)
data$debut_sejour_clean <- sub(":.*", "", data$debut_sejour)
data$fin_sejour_clean <- sub(":.*", "", data$fin_sejour)

# Passer en locale anglaise pour reconnaître les mois (JUL, MAR, etc.)
# pas besoin de ça si votre locale est en anglais déjà
Sys.setlocale("LC_TIME", "C")

# Convertir en format Date
data$date_greffe <- as.Date(data$date_greffe_clean, format="%d%b%Y")
data$debut_sejour <- as.Date(data$debut_sejour_clean, format="%d%b%Y")
data$fin_sejour <- as.Date(data$fin_sejour_clean, format="%d%b%Y")
```

## Création de la variable 'periode_greffe'

```{r}
data <- data %>%
  mutate(periode_greffe = if_else(debut_sejour < date_greffe, 
                                  "Pre_greffe", 
                                  "Post_greffe"))
table(data$periode_greffe)

### Tri de la base par date de greffe
```


```{r}
data <- data %>%arrange(date_greffe)
View(data)
```

## Création de la variable tranche d'âge

```{r}
data <- data %>%
  mutate(tranche_age = cut(AGE_ANN, 
                           breaks = c(0, 30, 40, 50, 60, 70, 80, 120),
labels = c("<30", "30-39", "40-49", "50-59", "60-69", "70-79", "≥80")
))
```

```{r}
# ==============================================================================
# RÉFÉRENTIEL DÉPARTEMENTS FRANÇAIS
# ==============================================================================

# Créer la table de correspondance code → nom département
ref_departements <- data.frame(
  code_dept = c(
    "01", "02", "03", "04", "05", "06", "07", "08", "09", "10",
    "11", "12", "13", "14", "15", "16", "17", "18", "19", "20",
    "21", "22", "23", "24", "25", "26", "27", "28", "29", "30",
    "31", "32", "33", "34", "35", "36", "37", "38", "39", "40",
    "41", "42", "43", "44", "45", "46", "47", "48", "49", "50",
    "51", "52", "53", "54", "55", "56", "57", "58", "59", "60",
    "61", "62", "63", "64", "65", "66", "67", "68", "69", "70",
    "71", "72", "73", "74", "75", "76", "77", "78", "79", "80",
    "81", "82", "83", "84", "85", "86", "87", "88", "89", "90",
    "91", "92", "93", "94", "95",
    "2A", "2B",  # Corse
    "971", "972", "973", "974", "976"  # DOM
  ),
  nom_dept = c(
    "Ain", "Aisne", "Allier", "Alpes-de-Haute-Provence", "Hautes-Alpes",
    "Alpes-Maritimes", "Ardèche", "Ardennes", "Ariège", "Aube",
    "Aude", "Aveyron", "Bouches-du-Rhône", "Calvados", "Cantal",
    "Charente", "Charente-Maritime", "Cher", "Corrèze", "Corse",
    "Côte-d'Or", "Côtes-d'Armor", "Creuse", "Dordogne", "Doubs",
    "Drôme", "Eure", "Eure-et-Loir", "Finistère", "Gard",
    "Haute-Garonne", "Gers", "Gironde", "Hérault", "Ille-et-Vilaine",
    "Indre", "Indre-et-Loire", "Isère", "Jura", "Landes",
    "Loir-et-Cher", "Loire", "Haute-Loire", "Loire-Atlantique", "Loiret",
    "Lot", "Lot-et-Garonne", "Lozère", "Maine-et-Loire", "Manche",
    "Marne", "Haute-Marne", "Mayenne", "Meurthe-et-Moselle", "Meuse",
    "Morbihan", "Moselle", "Nièvre", "Nord", "Oise",
    "Orne", "Pas-de-Calais", "Puy-de-Dôme", "Pyrénées-Atlantiques", "Hautes-Pyrénées",
    "Pyrénées-Orientales", "Bas-Rhin", "Haut-Rhin", "Rhône", "Haute-Saône",
    "Saône-et-Loire", "Sarthe", "Savoie", "Haute-Savoie", "Paris",
    "Seine-Maritime", "Seine-et-Marne", "Yvelines", "Deux-Sèvres", "Somme",
    "Tarn", "Tarn-et-Garonne", "Var", "Vaucluse", "Vendée",
    "Vienne", "Haute-Vienne", "Vosges", "Yonne", "Territoire de Belfort",
    "Essonne", "Hauts-de-Seine", "Seine-Saint-Denis", "Val-de-Marne", "Val-d'Oise",
    "Corse-du-Sud", "Haute-Corse",
    "Guadeloupe", "Martinique", "Guyane", "La Réunion", "Mayotte"
  ),
  region = c(
    "Auvergne-Rhône-Alpes", "Hauts-de-France", "Auvergne-Rhône-Alpes", "Provence-Alpes-Côte d'Azur", "Provence-Alpes-Côte d'Azur",
    "Provence-Alpes-Côte d'Azur", "Auvergne-Rhône-Alpes", "Grand Est", "Occitanie", "Grand Est",
    "Occitanie", "Occitanie", "Provence-Alpes-Côte d'Azur", "Normandie", "Auvergne-Rhône-Alpes",
    "Nouvelle-Aquitaine", "Nouvelle-Aquitaine", "Centre-Val de Loire", "Nouvelle-Aquitaine", "Corse",
    "Bourgogne-Franche-Comté", "Bretagne", "Nouvelle-Aquitaine", "Nouvelle-Aquitaine", "Bourgogne-Franche-Comté",
    "Auvergne-Rhône-Alpes", "Normandie", "Centre-Val de Loire", "Bretagne", "Occitanie",
    "Occitanie", "Occitanie", "Nouvelle-Aquitaine", "Occitanie", "Bretagne",
    "Centre-Val de Loire", "Centre-Val de Loire", "Auvergne-Rhône-Alpes", "Bourgogne-Franche-Comté", "Nouvelle-Aquitaine",
    "Centre-Val de Loire", "Auvergne-Rhône-Alpes", "Auvergne-Rhône-Alpes", "Pays de la Loire", "Centre-Val de Loire",
    "Occitanie", "Nouvelle-Aquitaine", "Occitanie", "Pays de la Loire", "Normandie",
    "Grand Est", "Grand Est", "Pays de la Loire", "Grand Est", "Grand Est",
    "Bretagne", "Grand Est", "Bourgogne-Franche-Comté", "Hauts-de-France", "Hauts-de-France",
    "Normandie", "Hauts-de-France", "Auvergne-Rhône-Alpes", "Nouvelle-Aquitaine", "Occitanie",
    "Occitanie", "Grand Est", "Grand Est", "Auvergne-Rhône-Alpes", "Bourgogne-Franche-Comté",
    "Bourgogne-Franche-Comté", "Pays de la Loire", "Auvergne-Rhône-Alpes", "Auvergne-Rhône-Alpes", "Île-de-France",
    "Normandie", "Île-de-France", "Île-de-France", "Nouvelle-Aquitaine", "Hauts-de-France",
    "Occitanie", "Occitanie", "Provence-Alpes-Côte d'Azur", "Provence-Alpes-Côte d'Azur", "Pays de la Loire",
    "Nouvelle-Aquitaine", "Nouvelle-Aquitaine", "Grand Est", "Bourgogne-Franche-Comté", "Bourgogne-Franche-Comté",
    "Île-de-France", "Île-de-France", "Île-de-France", "Île-de-France", "Île-de-France",
    "Corse", "Corse",
    "Guadeloupe", "Martinique", "Guyane", "La Réunion", "Mayotte"
  ),
  stringsAsFactors = FALSE
)



# ==============================================================================
# ÉTAPE 1 : Extraire les codes départements et joindre les noms
# ==============================================================================

data <- data %>%
  mutate(
    ETA_NUM_char = as.character(ETA_NUM),
    code_dept = substr(ETA_NUM_char, 1, 2)
  ) %>%
  # Jointure avec le référentiel
  left_join(ref_departements, by = "code_dept")

# Vérifier la jointure
verif_jointure <- data %>%
  group_by(code_dept, nom_dept, region) %>%
  summarise(nb_patients = n()) %>%
  ungroup() %>%
  arrange(desc(nb_patients))

cat("\n=== VÉRIFICATION JOINTURE ===\n")
cat("Départements avec nom :", sum(!is.na(verif_jointure$nom_dept)), "\n")
cat("Départements sans nom (à vérifier) :", sum(is.na(verif_jointure$nom_dept)), "\n\n")

# Afficher les départements sans nom (codes non reconnus)
if (sum(is.na(verif_jointure$nom_dept)) > 0) {
  cat("Codes non reconnus :\n")
  print(verif_jointure %>% filter(is.na(nom_dept)))
}

```

Code pour la création de la base

```{r}
saveRDS(data, "data.rds")
```
